---
apiVersion: apiextensions.k8s.io/v1
kind: CustomResourceDefinition
metadata:
  annotations:
    controller-gen.kubebuilder.io/version: v0.17.2
  name: exportpolicies.telemetry.datumapis.com
spec:
  group: telemetry.datumapis.com
  names:
    kind: ExportPolicy
    listKind: ExportPolicyList
    plural: exportpolicies
    singular: exportpolicy
  scope: Namespaced
  versions:
  - name: v1alpha1
    schema:
      openAPIV3Schema:
        description: ExportPolicy is the Schema for the export policy API.
        properties:
          apiVersion:
            description: |-
              APIVersion defines the versioned schema of this representation of an object.
              Servers should convert recognized schemas to the latest internal value, and
              may reject unrecognized values.
              More info: https://git.k8s.io/community/contributors/devel/sig-architecture/api-conventions.md#resources
            type: string
          kind:
            description: |-
              Kind is a string value representing the REST resource this object represents.
              Servers may infer this from the endpoint the client submits requests to.
              Cannot be updated.
              In CamelCase.
              More info: https://git.k8s.io/community/contributors/devel/sig-architecture/api-conventions.md#types-kinds
            type: string
          metadata:
            type: object
          spec:
            description: |-
              Describes the expected state of the ExportPolicy's configuration. The
              control plane will constantly evaluate the current state of exporters that
              are deployed and ensure it matches the expected configuration. This field
              is required when configuring an export policy.
            properties:
              sink:
                description: |-
                  Configures how telemetry data should be sent to a third-party telemetry
                  platforms.
                properties:
                  batch:
                    description: Configures how telemetry data should be batched before
                      sending to the sink.
                    properties:
                      maxSize:
                        default: 500
                        description: Maximum number of telemetry entries per batch.
                        type: integer
                      timeout:
                        default: 5s
                        description: Batch timeout before sending telemetry. Must
                          be a duration (e.g. 5s).
                        type: string
                    required:
                    - maxSize
                    - timeout
                    type: object
                  otlp_http:
                    description: |-
                      Configures the export policy to publish telemetry using the HTTP version of
                      the OTLP protocol.

                      See: https://opentelemetry.io/docs/specs/otel/protocol/
                    properties:
                      authentication:
                        description: Configures how the sink should authenticate with
                          the HTTP endpoint.
                        properties:
                          bearerToken:
                            description: |-
                              Configures the sink to use a Bearer token in the authorization header when
                              authenticating with the configured endpoint.
                            properties:
                              secretRef:
                                description: |-
                                  Configures which secret is used to retrieve the bearer token to add to the
                                  authorization header.
                                properties:
                                  key:
                                    description: The key within the secret that contains
                                      the necessary value.
                                    type: string
                                  name:
                                    description: The name of the secret
                                    type: string
                                required:
                                - key
                                - name
                                type: object
                            required:
                            - secretRef
                            type: object
                        type: object
                      http:
                        description: Configure an HTTP endpoint to use for publishing
                          telemetry data.
                        properties:
                          endpoint:
                            description: The HTTP endpoint that should be used to
                              publish telemetry data.
                            type: string
                        required:
                        - endpoint
                        type: object
                    type: object
                  retry:
                    description: |-
                      Configures the export policies' retry behavior when it fails to send
                      requests to the sink's endpoint. There's no guarantees that the export
                      policy will retry until success if the endpoint is not available or
                      configured incorrectly.
                    properties:
                      backoffDuration:
                        default: 5s
                        description: |-
                          Backoff duration that should be used to backoff when retrying requests.
                          Should be a duration string, e.g. `10s`.
                        type: string
                      maxAttempts:
                        default: 3
                        description: Maximum number of attempts before telemetry data
                          should be dropped.
                        type: integer
                    required:
                    - backoffDuration
                    - maxAttempts
                    type: object
                type: object
              sources:
                description: |-
                  Defines how the export policy should source telemetry data to publish to
                  the configured sinks. An export policy can define multiple telemetry
                  sources. The export policy will **not** de-duplicate telemetry data that
                  matches multiple sources.
                items:
                  description: |-
                    Defines how the export policy should source telemetry data from resources on
                    the platform.
                  properties:
                    metrics:
                      description: |-
                        Configures how the telemetry source should retrieve metric data from the
                        Datum Cloud platform.
                      properties:
                        metricsql:
                          description: |-
                            The MetricSQL option allows to user to provide a metricsql query that can
                            be used to select and filter metric data that should be published by the
                            export policy.

                            Here's an example of a metricsql query that will publish gateway metrics:

                            ``` {service_name=“networking.datumapis.com”, resource_kind="Gateway"} ```

                            See: https://docs.victoriametrics.com/metricsql/
                          type: string
                      type: object
                    name:
                      description: |-
                        A unique name given to the telemetry source within an export policy. Must
                        be a valid DNS label.
                      type: string
                  required:
                  - name
                  type: object
                type: array
            required:
            - sink
            - sources
            type: object
          status:
            description: |-
              Provides information on the current state of the export policy that was
              observed by the control plane. This will be continuously updated as the
              control plane monitors exporters.
            properties:
              conditions:
                description: |-
                  Provides status information on the current status of the sink. This can be
                  used to determine whether a sink is configured correctly and is exporting
                  telemetry data.

                  Known condition types are: "Ready"
                items:
                  description: Condition contains details for one aspect of the current
                    state of this API Resource.
                  properties:
                    lastTransitionTime:
                      description: |-
                        lastTransitionTime is the last time the condition transitioned from one status to another.
                        This should be when the underlying condition changed.  If that is not known, then using the time when the API field changed is acceptable.
                      format: date-time
                      type: string
                    message:
                      description: |-
                        message is a human readable message indicating details about the transition.
                        This may be an empty string.
                      maxLength: 32768
                      type: string
                    observedGeneration:
                      description: |-
                        observedGeneration represents the .metadata.generation that the condition was set based upon.
                        For instance, if .metadata.generation is currently 12, but the .status.conditions[x].observedGeneration is 9, the condition is out of date
                        with respect to the current state of the instance.
                      format: int64
                      minimum: 0
                      type: integer
                    reason:
                      description: |-
                        reason contains a programmatic identifier indicating the reason for the condition's last transition.
                        Producers of specific condition types may define expected values and meanings for this field,
                        and whether the values are considered a guaranteed API.
                        The value should be a CamelCase string.
                        This field may not be empty.
                      maxLength: 1024
                      minLength: 1
                      pattern: ^[A-Za-z]([A-Za-z0-9_,:]*[A-Za-z0-9_])?$
                      type: string
                    status:
                      description: status of the condition, one of True, False, Unknown.
                      enum:
                      - "True"
                      - "False"
                      - Unknown
                      type: string
                    type:
                      description: type of condition in CamelCase or in foo.example.com/CamelCase.
                      maxLength: 316
                      pattern: ^([a-z0-9]([-a-z0-9]*[a-z0-9])?(\.[a-z0-9]([-a-z0-9]*[a-z0-9])?)*/)?(([A-Za-z0-9][-A-Za-z0-9_.]*)?[A-Za-z0-9])$
                      type: string
                  required:
                  - lastTransitionTime
                  - message
                  - reason
                  - status
                  - type
                  type: object
                type: array
            type: object
        required:
        - spec
        type: object
    served: true
    storage: true
